<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dummy Test</title>
</head>
<body>
<h3 id="test-title">Dummy Test</h3>
<script>
    (async function () {
        const cleanWindowObjectKeys = Object.keys(window);
        const pluginPrefix = '/js/gigya.services.plugins.base.min.js?services=';

        function setTitle(pluginName) {
            document.getElementById("test-title").innerHTML = `Validating global object for ${pluginName}`;
        }
        function evaluateGlobalObjectDiff() {
            return Object.keys(window).filter(key => !cleanWindowObjectKeys.includes(key));
        }
        function urlParams() {
            const urlSearchParams = new URLSearchParams(window.location.search);
            return Object.fromEntries(urlSearchParams.entries());
        }
        async function loadScript(scriptSrc) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.async = true;
                script.type = 'text/javascript';

                script.onerror = reject;
                script.onload = resolve;
                script['onreadystatechange'] = function() {
                    if (this.readyState === 'loaded') {
                        resolve();
                    }
                };
                const head = document.getElementsByTagName('head');
                if (head && head.length > 0) {
                    head[0].appendChild(script);
                }
                script.src = scriptSrc;
            });
        }
        async function loadGigya() {
            await loadScript(`/js/gigya.js?apiKey=mock-api-key`);
        }
        async function loadPlugin(plugin) {
            await loadGigya();
            await loadScript(plugin);
        }

        async function evaluate() {
            const params = urlParams();
            setTitle(params['plugin']);
            await loadPlugin(`${pluginPrefix}${params['plugin']}`);
            window.parent.postMessage(JSON.stringify({
                globalObjectDiff: evaluateGlobalObjectDiff(),
                pluginName: params['plugin']
            }), '*');
        }

        await evaluate();
    })();
</script>
</body>
</html>
